{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspace": {
            "type": "String"
        }
    },
    "resources": [
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/6167da1c-2c85-4ff3-b23a-081cf304fa48')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/6167da1c-2c85-4ff3-b23a-081cf304fa48')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "Detect Registry Run Key Creation/Modification",
                "description": "This analytic rule detects any registry value or key creation in the registry run keys. This could be an indication of a persistence attempt by an adversary.",
                "severity": "Medium",
                "enabled": true,
                "query": "// List of startup registry keys to monitor\nlet startupRegistryList = dynamic([\n    'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run',\n    'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce',\n    'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Run',\n    'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnce',\n    'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunOnceEx',\n    'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServicesOnce',\n    'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServicesOnce',\n    'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServices',\n    'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\RunServices',\n    'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run',\n    'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows\\\\CurrentVersion\\\\Policies\\\\Explorer\\\\Run',\n    'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Userinit',\n    'HKEY_LOCAL_MACHINE\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Winlogon\\\\Shell',\n    'HKEY_CURRENT_USER\\\\Software\\\\Microsoft\\\\Windows NT\\\\CurrentVersion\\\\Windows'\n  ]);\n_ASim_RegistryEvent\n| where EventType in ('RegistryValueSet', 'RegistryKeyCreated') and RegistryKey has_any (startupRegistryList)\n| project\n    TimeGenerated,\n    DvcHostname,\n    ActorUsername,\n    ActorUsernameType,\n    ActingProcessId,\n    ActingProcessName,\n    ActingProcessCommandLine,\n    RegistryKey,\n    RegistryValue,\n    RegistryValueType,\n    RegistryValueData\n| extend HostName = tostring(split(DvcHostname, '.')[0])\n| extend DnsDomain = tostring(strcat_array(array_slice(split(DvcHostname, '.'), 1, -1), '.'))\n| extend Username = iff(tostring(ActorUsernameType) == 'Windows', tostring(split(ActorUsername, '\\\\')[1]), ActorUsername)\n| extend NTDomain = iff(tostring(ActorUsernameType) == 'Windows', tostring(split(ActorUsername, '\\\\')[0]), ActorUsername)\n| extend Username = iff(tostring(ActorUsernameType) == 'UPN', tostring(split(ActorUsername, '@')[0]), Username)\n| extend UPNSuffix = iff(tostring(ActorUsernameType) == 'UPN', tostring(split(ActorUsername, '@')[1]), '')\n| extend RegHive = tostring(split(RegistryKey, '\\\\')[0]), RegKey = tostring(strcat_array(array_slice(split(RegistryKey, '\\\\'), 1, -1), '\\\\')) \n",
                "queryFrequency": "PT5H",
                "queryPeriod": "P1D",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT1H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "Persistence",
                    "PrivilegeEscalation",
                    "DefenseEvasion"
                ],
                "techniques": [
                    "T1547",
                    "T1112"
                ],
                "subTechniques": [],
                "alertRuleTemplateName": "dd041e4e-1ee2-41ec-ba4e-82a71d628260",
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": true,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": {
                    "alertDisplayNameFormat": "Registry Run Keys Modified on {{DvcHostname}} by ({{ActorUsername}})",
                    "alertDescriptionFormat": "Process {{ActingProcessName}} ProcessId: ({{ActingProcessId}}) modified registry run key {{RegistryKey}}.",
                    "alertDynamicProperties": []
                },
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "HostName",
                                "columnName": "HostName"
                            },
                            {
                                "identifier": "DnsDomain",
                                "columnName": "DnsDomain"
                            },
                            {
                                "identifier": "NTDomain",
                                "columnName": "NTDomain"
                            }
                        ]
                    },
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "Name",
                                "columnName": "Username"
                            },
                            {
                                "identifier": "UPNSuffix",
                                "columnName": "UPNSuffix"
                            },
                            {
                                "identifier": "NTDomain",
                                "columnName": "NTDomain"
                            }
                        ]
                    },
                    {
                        "entityType": "Process",
                        "fieldMappings": [
                            {
                                "identifier": "ProcessId",
                                "columnName": "ActingProcessId"
                            },
                            {
                                "identifier": "CommandLine",
                                "columnName": "ActingProcessCommandLine"
                            }
                        ]
                    },
                    {
                        "entityType": "RegistryKey",
                        "fieldMappings": [
                            {
                                "identifier": "Hive",
                                "columnName": "RegHive"
                            },
                            {
                                "identifier": "Key",
                                "columnName": "RegKey"
                            }
                        ]
                    },
                    {
                        "entityType": "RegistryValue",
                        "fieldMappings": [
                            {
                                "identifier": "Name",
                                "columnName": "RegistryValue"
                            },
                            {
                                "identifier": "Value",
                                "columnName": "RegistryValueData"
                            },
                            {
                                "identifier": "ValueType",
                                "columnName": "RegistryValueType"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": "1.0.0"
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/4bd1f025-1803-42ce-a25a-a0e9af396ec1')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/4bd1f025-1803-42ce-a25a-a0e9af396ec1')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "detect data from local system",
                "description": "",
                "severity": "Medium",
                "enabled": true,
                "query": "// Adjust the table name based on your connected data sources (e.g., DeviceProcessEvents, SecurityEvent, Sysmon_CL)\r\nDeviceProcessEvents\r\n| where ProcessCommandLine contains \".zip\" or ProcessCommandLine contains \".rar\" or ProcessCommandLine contains \".tgz\"\r\n| project TimeGenerated, DeviceName, InitiatingProcessAccountName, FileName, ProcessCommandLine, FolderPath\r\n| extend timestamp = TimeGenerated, AccountCustomEntity = InitiatingProcessAccountName, HostCustomEntity = DeviceName\r\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5H",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "Collection"
                ],
                "techniques": [
                    "T1005"
                ],
                "subTechniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": true,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": null,
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/132ce189-ba9a-4201-8531-6c0df9b34479')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/132ce189-ba9a-4201-8531-6c0df9b34479')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "Detect and respond to credential dumping",
                "description": "",
                "severity": "Medium",
                "enabled": true,
                "query": "(Event\r\n| where Source == \"Microsoft-Windows-Sysmon\"\r\n| where EventID == 1\r\n| where RenderedDescription has \"appcmd.exe\"\r\n| where RenderedDescription has_any(\"list apppool\", \"/@text:*\", \"/config\")\r\n| extend Technique = \"T1003-004/005 - IIS Credentials\",\r\n         Account = extract(\"User: (.*?)\\\\s*LogonGuid:\", 1, RenderedDescription),\r\n         CommandLine = extract(\"CommandLine: (.*?)\\\\s*CurrentDirectory:\", 1, RenderedDescription)\r\n)\r\n| union \r\n(Event\r\n| where Source == \"Microsoft-Windows-Sysmon\"\r\n| where EventID == 1\r\n| where RenderedDescription has_all(\"rundll32.exe\", \"keymgr.dll\", \"CredEnumerate\")\r\n| extend Technique = \"T1003-006 - Credential Manager Dump\",\r\n         Account = extract(\"User: (.*?)\\\\s*LogonGuid:\", 1, RenderedDescription),\r\n         CommandLine = extract(\"CommandLine: (.*?)\\\\s*CurrentDirectory:\", 1, RenderedDescription)\r\n)\r\n| union\r\n(Event\r\n| where Source == \"Microsoft-Windows-Sysmon\"\r\n| where EventID == 1\r\n| where RenderedDescription has \"svchost.exe\"\r\n| extend ParentImage = extract(\"ParentImage: (.*?)\\\\s\", 1, RenderedDescription)\r\n| where ParentImage has_any(\"procdump.exe\", \"WerFault.exe\", \"taskmgr.exe\")\r\n| extend Technique = \"T1003-003 - RDP Credential Dump\",\r\n         Account = extract(\"User: (.*?)\\\\s*LogonGuid:\", 1, RenderedDescription),\r\n         CommandLine = extract(\"CommandLine: (.*?)\\\\s*CurrentDirectory:\", 1, RenderedDescription)\r\n)\r\n| project TimeGenerated, Computer, Account, Technique, CommandLine\r\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5H",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "CredentialAccess"
                ],
                "techniques": [],
                "subTechniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": true,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Account"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "HostName",
                                "columnName": "Computer"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/84e486e8-e406-417f-bdcf-c29cf733fab2')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/84e486e8-e406-417f-bdcf-c29cf733fab2')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "Dtect and respond to suspicious BITS activity",
                "description": "",
                "severity": "Medium",
                "enabled": true,
                "query": "Event\r\n| where Source == \"Microsoft-Windows-Sysmon\"\r\n| where EventID == 1\r\n| where RenderedDescription has \"bitsadmin.exe\"\r\n| extend CommandLine = extract(\"CommandLine: (.*?)\\\\s*CurrentDirectory:\", 1, RenderedDescription)\r\n| extend Account = extract(\"User: (.*?)\\\\s*LogonGuid:\", 1, RenderedDescription)\r\n// Filter for commands that might download files or set notify flags maliciously\r\n| where CommandLine has_any(\"/addfile\", \"/transfer\", \"/SetNotifyCmdLine\")\r\n| project TimeGenerated, Computer, Account, CommandLine\r\n",
                "queryFrequency": "PT5M",
                "queryPeriod": "PT5H",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "Persistence",
                    "DefenseEvasion"
                ],
                "techniques": [
                    "T1197"
                ],
                "subTechniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": true,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "Name",
                                "columnName": "Account"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "HostName",
                                "columnName": "Computer"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        },
        {
            "id": "[concat(resourceId('Microsoft.OperationalInsights/workspaces/providers', parameters('workspace'), 'Microsoft.SecurityInsights'),'/alertRules/38052965-b3f0-4d02-a779-acf188756a71')]",
            "name": "[concat(parameters('workspace'),'/Microsoft.SecurityInsights/38052965-b3f0-4d02-a779-acf188756a71')]",
            "type": "Microsoft.OperationalInsights/workspaces/providers/alertRules",
            "kind": "Scheduled",
            "apiVersion": "2023-12-01-preview",
            "properties": {
                "displayName": "detect and respond to registry modification",
                "description": "",
                "severity": "Medium",
                "enabled": true,
                "query": "Event\r\n| where Source == \"Microsoft-Windows-Sysmon\"\r\n| where EventID in (12, 13) // Registry object added/deleted or value set\r\n| where RenderedDescription has_any(\"Run\", \"RunOnce\", \"DisableAntiSpyware\", \"ImagePath\")\r\n| extend Details = RenderedDescription\r\n| extend Account = extract(\"User: (.*?)\\\\s*ProcessGuid:\", 1, RenderedDescription)\r\n| project TimeGenerated, Computer, Account, Details\r\n",
                "queryFrequency": "PT5H",
                "queryPeriod": "PT5H",
                "triggerOperator": "GreaterThan",
                "triggerThreshold": 0,
                "suppressionDuration": "PT5H",
                "suppressionEnabled": false,
                "startTimeUtc": null,
                "tactics": [
                    "DefenseEvasion"
                ],
                "techniques": [
                    "T1112"
                ],
                "subTechniques": [],
                "alertRuleTemplateName": null,
                "incidentConfiguration": {
                    "createIncident": true,
                    "groupingConfiguration": {
                        "enabled": true,
                        "reopenClosedIncident": false,
                        "lookbackDuration": "PT5H",
                        "matchingMethod": "AllEntities",
                        "groupByEntities": [],
                        "groupByAlertDetails": [],
                        "groupByCustomDetails": []
                    }
                },
                "eventGroupingSettings": {
                    "aggregationKind": "SingleAlert"
                },
                "alertDetailsOverride": null,
                "customDetails": null,
                "entityMappings": [
                    {
                        "entityType": "Account",
                        "fieldMappings": [
                            {
                                "identifier": "FullName",
                                "columnName": "Account"
                            }
                        ]
                    },
                    {
                        "entityType": "Host",
                        "fieldMappings": [
                            {
                                "identifier": "HostName",
                                "columnName": "Computer"
                            }
                        ]
                    }
                ],
                "sentinelEntitiesMappings": null,
                "templateVersion": null
            }
        }
    ]
}